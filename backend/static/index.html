<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theria - Zone Control</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .zone-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .zone-name {
            font-size: 1.8rem;
            color: #333;
            font-weight: 600;
        }

        .avg-temp {
            font-size: 2rem;
            color: #667eea;
            font-weight: bold;
        }

        .section-title {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .temp-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .temp-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .temp-card.climate {
            border-left-color: #48bb78;
        }

        .temp-card.sensor {
            border-left-color: #ed8936;
        }

        .temp-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }

        .temp-value {
            font-size: 1.5rem;
            color: #333;
            font-weight: 600;
        }

        .climate-info {
            font-size: 0.75rem;
            color: #999;
            margin-top: 5px;
        }

        .control-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 25px;
        }

        .control-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .control-label {
            font-size: 1.1rem;
            color: #333;
            font-weight: 600;
            min-width: 150px;
        }

        .temp-input {
            flex: 1;
            max-width: 150px;
            padding: 12px 15px;
            font-size: 1.2rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
        }

        .temp-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.95rem;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1rem;
        }

        .error-card {
            background: #fee;
            border-left: 4px solid #e53e3e;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            transform: rotate(180deg);
            background: #667eea;
            color: white;
        }

        @media (max-width: 600px) {
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }

            .temp-input {
                max-width: 100%;
            }
        }

        @media (max-width: 900px) {
            #historyCard > div > div {
                grid-template-columns: 1fr !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå°Ô∏è Theria</h1>
            <p>Smart Zone Temperature Control</p>
        </div>

        <div id="content">
            <div class="card">
                <div class="loading">‚è≥ Loading zone data...</div>
            </div>
        </div>
    </div>

    <div class="refresh-btn" onclick="loadZoneStatus()" title="Refresh">
        ‚Üª
    </div>

    <script>
        const ZONE_ID = 'butik'; // Will be dynamic in future
        let refreshInterval = null;
        let historyData = [];
        let eventsData = [];
        let chartVantsidan = null;
        let chartKlippsidan = null;
        let priceData = null;
        let thermalData = null;

        async function loadZoneStatus() {
            // Save scroll position at the start
            const savedScrollY = window.scrollY;

            try {
                // Add timeout to fetch request
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(`/api/zones/${ZONE_ID}/status`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                renderZone(data, savedScrollY);

                // Load history, events, price, and thermal data (non-blocking)
                loadHistory();
                loadEvents();
                loadPrice();
                loadThermalCharacteristics();

                // Restore scroll position after all rendering is complete
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        window.scrollTo(0, savedScrollY);
                    });
                });
            } catch (error) {
                console.error('Error loading zone:', error);
                const errorMsg = error.name === 'AbortError'
                    ? 'Request timeout - check HA connection'
                    : error.message;
                document.getElementById('content').innerHTML = `
                    <div class="card error-card">
                        <h3>‚ö†Ô∏è Error Loading Zone</h3>
                        <p>${errorMsg}</p>
                        <p>Make sure Home Assistant is connected and the zone is configured correctly.</p>
                    </div>
                `;
            }
        }

        async function loadHistory() {
            try {
                const response = await fetch(`/api/zones/${ZONE_ID}/history?hours=24`);
                if (!response.ok) return;

                const data = await response.json();
                historyData = data.history;
                renderHistory();
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        async function loadEvents() {
            try {
                const response = await fetch(`/api/zones/${ZONE_ID}/events?hours=24`);
                if (!response.ok) return;

                const data = await response.json();
                eventsData = data.events;
                renderEvents();
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        async function loadPrice() {
            try {
                const response = await fetch('/api/price/current');
                if (!response.ok) return;

                const data = await response.json();
                priceData = data;
                renderPrice();
            } catch (error) {
                console.error('Error loading price:', error);
            }
        }

        async function loadThermalCharacteristics() {
            try {
                const response = await fetch(`/api/thermal/characteristics?zone_id=${ZONE_ID}`);
                if (!response.ok) return;

                const data = await response.json();
                thermalData = data;
                renderThermalCharacteristics();
            } catch (error) {
                console.error('Error loading thermal characteristics:', error);
            }
        }

        function renderZone(zone, savedScrollY) {
            // Check if this is first render
            const isFirstRender = !document.getElementById('zoneCard');

            if (isFirstRender) {
                // First render - create full HTML structure
                renderZoneInitial(zone);
            } else {
                // Subsequent renders - only update changing values
                updateZoneValues(zone);
            }
        }

        function updateZoneValues(zone) {
            // Update average temperature
            const avgTempDisplay = zone.average_temperature
                ? `${zone.average_temperature.toFixed(1)}¬∞C`
                : 'N/A';
            const avgTempEl = document.getElementById('avgTemp');
            if (avgTempEl) avgTempEl.textContent = avgTempDisplay;

            // Update scheduled temperature
            const scheduledTempDisplay = zone.scheduled_temperature
                ? `${zone.scheduled_temperature.toFixed(1)}¬∞C`
                : 'No schedule';
            const scheduledTempEl = document.getElementById('scheduledTemp');
            if (scheduledTempEl) scheduledTempEl.textContent = scheduledTempDisplay;

            // Update climate states
            const climateGrid = document.getElementById('climateGrid');
            if (climateGrid) {
                climateGrid.innerHTML = zone.climate_states.map(climate => `
                    <div class="temp-card climate">
                        <div class="temp-label">${climate.entity_id.replace('climate.', '')}</div>
                        <div class="temp-value">
                            ${climate.current_temperature ? climate.current_temperature.toFixed(1) + '¬∞C' : 'N/A'}
                        </div>
                        <div class="climate-info">
                            Target: ${climate.target_temperature ? climate.target_temperature + '¬∞C' : 'N/A'} |
                            Mode: ${climate.hvac_mode || 'N/A'}
                        </div>
                    </div>
                `).join('');
            }

            // Update sensor temperatures
            const sensorTemps = zone.temperatures.filter(t => t.entity_id.startsWith('sensor.'));
            const sensorGrid = document.getElementById('sensorGrid');
            if (sensorGrid && sensorTemps.length > 0) {
                sensorGrid.innerHTML = sensorTemps.map(temp => `
                    <div class="temp-card sensor">
                        <div class="temp-label">${temp.entity_id.replace('sensor.', '').replace(/_/g, ' ')}</div>
                        <div class="temp-value">
                            ${temp.temperature ? temp.temperature.toFixed(1) + '¬∞C' : 'N/A'}
                        </div>
                        ${temp.error ? `<div class="climate-info" style="color: #e53e3e;">${temp.error}</div>` : ''}
                    </div>
                `).join('');
            }
        }

        function renderZoneInitial(zone) {
            const avgTempDisplay = zone.average_temperature
                ? `${zone.average_temperature.toFixed(1)}¬∞C`
                : 'N/A';

            const scheduledTempDisplay = zone.scheduled_temperature
                ? `${zone.scheduled_temperature.toFixed(1)}¬∞C`
                : 'No schedule';

            // Separate climate and sensor temperatures
            const climateTemps = zone.temperatures.filter(t =>
                t.entity_id.startsWith('climate.')
            );
            const sensorTemps = zone.temperatures.filter(t =>
                t.entity_id.startsWith('sensor.')
            );

            const html = `
                <div class="card" id="zoneCard">
                    <div class="zone-header">
                        <div class="zone-name">${zone.name}</div>
                        <div class="avg-temp" id="avgTemp">${avgTempDisplay}</div>
                    </div>

                    <div id="priceIndicator" style="display: none; background: #f0f7ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                        <!-- Price info will be rendered here -->
                    </div>

                    ${zone.schedule && zone.schedule.length > 0 ? `
                        <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                            <div style="font-weight: 600; color: #667eea; margin-bottom: 8px;">üìÖ Active Schedule</div>
                            <div style="font-size: 1.3rem; color: #333; margin-bottom: 10px;">
                                Current Target: <strong id="scheduledTemp">${scheduledTempDisplay}</strong>
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                ${zone.schedule.map(entry => `
                                    <div style="background: white; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem;">
                                        ${entry.time} ‚Üí ${entry.target_temp}¬∞C
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="section-title">Climate Entities</div>
                    <div class="temp-grid" id="climateGrid">
                        ${zone.climate_states.map(climate => `
                            <div class="temp-card climate">
                                <div class="temp-label">${climate.entity_id.replace('climate.', '')}</div>
                                <div class="temp-value">
                                    ${climate.current_temperature ? climate.current_temperature.toFixed(1) + '¬∞C' : 'N/A'}
                                </div>
                                <div class="climate-info">
                                    Target: ${climate.target_temperature ? climate.target_temperature + '¬∞C' : 'N/A'} |
                                    Mode: ${climate.hvac_mode || 'N/A'}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    ${sensorTemps.length > 0 ? `
                        <div class="section-title">Additional Sensors</div>
                        <div class="temp-grid" id="sensorGrid">
                            ${sensorTemps.map(temp => `
                                <div class="temp-card sensor">
                                    <div class="temp-label">${temp.entity_id.replace('sensor.', '').replace(/_/g, ' ')}</div>
                                    <div class="temp-value">
                                        ${temp.temperature ? temp.temperature.toFixed(1) + '¬∞C' : 'N/A'}
                                    </div>
                                    ${temp.error ? `<div class="climate-info" style="color: #e53e3e;">${temp.error}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <div class="control-section">
                        <div class="section-title">Set Temperature</div>
                        <div class="control-row">
                            <label class="control-label">Target Temperature:</label>
                            <input type="number"
                                   id="targetTemp"
                                   class="temp-input"
                                   value="21"
                                   min="15"
                                   max="30"
                                   step="0.5">
                            <button class="btn btn-primary" onclick="setTemperature()">
                                Apply
                            </button>
                        </div>
                        <div id="statusMessage" class="status-message"></div>
                    </div>
                </div>

                <div class="card" id="historyCard" style="display: none;">
                    <div class="section-title">üìä Temperature History (24h)</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div>
                            <h4 style="color: #666; margin-bottom: 10px; font-size: 0.9rem;">V√§ntesidan</h4>
                            <canvas id="chartVantsidan"></canvas>
                        </div>
                        <div>
                            <h4 style="color: #666; margin-bottom: 10px; font-size: 0.9rem;">Klippsidan</h4>
                            <canvas id="chartKlippsidan"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card" id="eventsCard" style="display: none;">
                    <div class="section-title">üìù Recent Control Events</div>
                    <div id="eventsList"></div>
                </div>

                <div class="card" id="thermalCard" style="display: none;">
                    <div class="section-title">üß† Learned Thermal Characteristics</div>
                    <div id="thermalContent"></div>
                </div>
            `;

            document.getElementById('content').innerHTML = html;
        }

        function renderHistory() {
            const historyCard = document.getElementById('historyCard');

            if (!historyData || historyData.length === 0) {
                historyCard.style.display = 'none';
                return;
            }

            historyCard.style.display = 'block';

            // Extract data for each climate sensor
            const vantsidanData = historyData.map(reading => {
                const time = new Date(reading.timestamp);
                return {
                    time: time,
                    currentTemp: reading.current_temps?.['climate.vantsidan'],
                    targetTemp: reading.target_temps?.['climate.vantsidan'],
                    scheduledTemp: reading.scheduled_temp
                };
            });

            const klippsidanData = historyData.map(reading => {
                const time = new Date(reading.timestamp);
                return {
                    time: time,
                    currentTemp: reading.current_temps?.['climate.klippsidan'],
                    targetTemp: reading.target_temps?.['climate.klippsidan'],
                    scheduledTemp: reading.scheduled_temp
                };
            });

            // Create chart for V√§ntesidan
            createOrUpdateChart('chartVantsidan', 'chartVantsidan', vantsidanData);

            // Create chart for Klippsidan
            createOrUpdateChart('chartKlippsidan', 'chartKlippsidan', klippsidanData);
        }

        function createOrUpdateChart(canvasId, chartVarName, data) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            const labels = data.map(d => d.time.toLocaleTimeString('sv-SE', {hour: '2-digit', minute: '2-digit'}));

            // Get existing chart reference
            let chart = chartVarName === 'chartVantsidan' ? chartVantsidan : chartKlippsidan;

            // Check if chart exists AND its canvas is still in the DOM
            if (chart && chart.canvas && chart.canvas.isConnected) {
                chart.data.labels = labels;
                chart.data.datasets[0].data = data.map(d => d.currentTemp);
                chart.data.datasets[1].data = data.map(d => d.targetTemp);
                chart.data.datasets[2].data = data.map(d => d.scheduledTemp);
                chart.update('none'); // Update without animation
                return;
            }

            // If chart exists but canvas was destroyed, clean it up
            if (chart) {
                try {
                    chart.destroy();
                } catch (e) {
                    // Ignore errors if already destroyed
                }
                chart = null;
            }

            // Create new chart only if it doesn't exist
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Current',
                            data: data.map(d => d.currentTemp),
                            borderColor: '#ed8936',
                            backgroundColor: 'rgba(237, 137, 54, 0.1)',
                            borderWidth: 2.5,
                            tension: 0.3,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Target',
                            data: data.map(d => d.targetTemp),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 4
                        },
                        {
                            label: 'Scheduled',
                            data: data.map(d => d.scheduledTemp),
                            borderColor: '#48bb78',
                            backgroundColor: 'rgba(72, 187, 120, 0.1)',
                            borderWidth: 1.5,
                            borderDash: [5, 5],
                            tension: 0,
                            pointRadius: 0,
                            pointHoverRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    animation: false, // Disable animations for smooth updates
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 12,
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(1) + '¬∞C';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxTicksLimit: 6,
                                font: {
                                    size: 10
                                }
                            }
                        },
                        y: {
                            display: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + '¬∞C';
                                },
                                font: {
                                    size: 10
                                }
                            },
                            suggestedMin: 17,
                            suggestedMax: 23
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });

            // Store chart reference
            if (chartVarName === 'chartVantsidan') {
                chartVantsidan = chart;
            } else if (chartVarName === 'chartKlippsidan') {
                chartKlippsidan = chart;
            }
        }

        function renderPrice() {
            const priceIndicator = document.getElementById('priceIndicator');
            if (!priceIndicator) return;

            if (!priceData || !priceData.enabled) {
                priceIndicator.style.display = 'none';
                return;
            }

            priceIndicator.style.display = 'block';

            let statusIcon = 'üí∞';
            let statusText = 'Normal';
            let borderColor = '#667eea';
            let bgColor = '#f0f7ff';

            if (priceData.is_expensive_hour) {
                statusIcon = 'üìâ';
                statusText = 'Expensive Hour - Saving energy';
                borderColor = '#e53e3e';
                bgColor = '#fff5f5';
            } else if (priceData.is_cheap_hour) {
                statusIcon = 'üìà';
                statusText = 'Cheap Hour - Pre-heating';
                borderColor = '#48bb78';
                bgColor = '#f0fff4';
            }

            priceIndicator.style.borderLeftColor = borderColor;
            priceIndicator.style.background = bgColor;

            priceIndicator.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; color: #333; margin-bottom: 4px;">
                            ${statusIcon} Electricity Price
                        </div>
                        <div style="font-size: 0.9rem; color: #666;">
                            ${statusText}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${borderColor};">
                            ${priceData.current_price !== null ? priceData.current_price.toFixed(2) : '‚Äî'} ¬¢/kWh
                        </div>
                        ${priceData.price_adjustment !== 0 ? `
                            <div style="font-size: 0.85rem; color: ${borderColor}; font-weight: 600;">
                                ${priceData.price_adjustment > 0 ? '+' : ''}${priceData.price_adjustment.toFixed(1)}¬∞C
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderThermalCharacteristics() {
            const thermalCard = document.getElementById('thermalCard');
            const thermalContent = document.getElementById('thermalContent');

            if (!thermalCard || !thermalContent) return;

            if (!thermalData) {
                thermalCard.style.display = 'none';
                return;
            }

            thermalCard.style.display = 'block';

            // Calculate confidence color
            const confidence = thermalData.overall_confidence || 0;
            let confidenceColor = '#e53e3e'; // Red for low
            if (confidence > 0.7) confidenceColor = '#48bb78'; // Green for high
            else if (confidence > 0.4) confidenceColor = '#ed8936'; // Orange for medium

            const lastUpdated = thermalData.last_updated
                ? new Date(thermalData.last_updated).toLocaleString('sv-SE', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                  })
                : 'Never';

            thermalContent.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <!-- Confidence Badge -->
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${confidenceColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 3px;">Overall Confidence</div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: ${confidenceColor};">
                                    ${(confidence * 100).toFixed(0)}%
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.75rem; color: #999;">Last Updated</div>
                                <div style="font-size: 0.85rem; color: #666;">${lastUpdated}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Thermal Rates Grid -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <!-- Heating Rate -->
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #e53e3e;">
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 8px;">üî• Heating Rate</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #333;">
                                ${thermalData.heating_rate >= 0 ? '+' : ''}${thermalData.heating_rate.toFixed(2)} ¬∞C/h
                            </div>
                            <div style="margin-top: 8px; font-size: 0.75rem; color: #999;">
                                Confidence: ${(thermalData.heating_rate_confidence * 100).toFixed(0)}%
                                (${thermalData.heating_samples} samples)
                            </div>
                        </div>

                        <!-- Cooling Rate -->
                        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 8px;">‚ùÑÔ∏è Cooling Rate</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #333;">
                                ${thermalData.cooling_rate_base.toFixed(2)} ¬∞C/h
                            </div>
                            <div style="margin-top: 8px; font-size: 0.75rem; color: #999;">
                                Confidence: ${(thermalData.cooling_rate_confidence * 100).toFixed(0)}%
                                (${thermalData.cooling_samples} samples)
                            </div>
                        </div>
                    </div>

                    <!-- Additional Info -->
                    <div style="background: white; padding: 12px; border-radius: 8px; font-size: 0.85rem;">
                        <div style="color: #666;">
                            <strong>Outdoor Temp Coefficient:</strong>
                            ${thermalData.outdoor_temp_coefficient.toFixed(3)} ¬∞C/h per ¬∞C
                        </div>
                        <div style="color: #999; margin-top: 5px; font-size: 0.75rem;">
                            Recent measurements: ${thermalData.recent_measurements}
                        </div>
                    </div>

                    ${confidence < 0.5 ? `
                        <div style="background: #fff5f5; padding: 12px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #e53e3e;">
                            <div style="color: #721c24; font-size: 0.85rem;">
                                ‚ö†Ô∏è <strong>Learning in progress...</strong> Confidence will improve as more data is collected.
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderEvents() {
            const eventsCard = document.getElementById('eventsCard');
            const eventsList = document.getElementById('eventsList');

            if (!eventsData || eventsData.length === 0) {
                eventsCard.style.display = 'none';
                return;
            }

            eventsCard.style.display = 'block';

            const eventsHtml = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    ${eventsData.slice(-10).reverse().map(event => {
                        const time = new Date(event.timestamp);
                        const timeStr = time.toLocaleString('sv-SE', {
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        const icon = event.action === 'manual_override' ? 'üë§' : 'ü§ñ';
                        const color = event.action === 'manual_override' ? '#ed8936' : '#48bb78';

                        return `
                            <div style="background: white; padding: 12px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid ${color};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                                    <div style="font-weight: 600; color: #333;">
                                        ${icon} ${event.action.replace('_', ' ').toUpperCase()}
                                    </div>
                                    <div style="color: #999; font-size: 0.8rem;">
                                        ${timeStr}
                                    </div>
                                </div>
                                <div style="color: #666; font-size: 0.9rem;">
                                    ${event.details}
                                </div>
                                ${event.temperature ? `
                                    <div style="color: #667eea; font-weight: 600; margin-top: 5px;">
                                        ${event.temperature}¬∞C
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                    <div style="color: #999; font-size: 0.75rem; margin-top: 10px;">
                        Showing last ${Math.min(10, eventsData.length)} of ${eventsData.length} events
                    </div>
                </div>
            `;

            eventsList.innerHTML = eventsHtml;
        }

        async function setTemperature() {
            const tempInput = document.getElementById('targetTemp');
            const temperature = parseFloat(tempInput.value);
            const statusDiv = document.getElementById('statusMessage');
            const button = event.target;

            if (isNaN(temperature) || temperature < 15 || temperature > 30) {
                showStatus('Please enter a valid temperature between 15¬∞C and 30¬∞C', 'error');
                return;
            }

            button.disabled = true;
            button.textContent = 'Applying...';

            try {
                // Send command to HA
                const response = await fetch(`/api/zones/${ZONE_ID}/set_temperature`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ temperature })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `HTTP ${response.status}`);
                }

                const result = await response.json();
                const successCount = result.results.length;
                const totalCount = successCount + (result.errors?.length || 0);

                // Show optimistic update
                showStatus(
                    `‚è≥ Syncing ${temperature}¬∞C to ${successCount}/${totalCount} radiators...`,
                    'success'
                );
                button.textContent = 'Syncing...';

                // Verify in background (poll until confirmed or timeout)
                await verifyTemperatureSet(temperature, successCount, 30);

                // Reload events to show the manual override
                setTimeout(() => loadEvents(), 1000);

            } catch (error) {
                console.error('Error setting temperature:', error);
                showStatus(`‚úó Failed to set temperature: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Apply';
            }
        }

        async function verifyTemperatureSet(targetTemp, expectedCount, timeoutSeconds) {
            const startTime = Date.now();
            const pollInterval = 2000; // Poll every 2 seconds
            let attempts = 0;

            while (Date.now() - startTime < timeoutSeconds * 1000) {
                attempts++;
                await new Promise(resolve => setTimeout(resolve, pollInterval));

                try {
                    const response = await fetch(`/api/zones/${ZONE_ID}/status`);
                    if (!response.ok) continue;

                    const data = await response.json();

                    // Count how many radiators have the target temperature
                    const synced = data.climate_states.filter(c =>
                        c.target_temperature === targetTemp
                    ).length;

                    if (synced === expectedCount) {
                        // Success - all synced!
                        showStatus(
                            `‚úì Temperature confirmed at ${targetTemp}¬∞C on all radiators`,
                            'success'
                        );
                        loadZoneStatus(); // Final refresh
                        return;
                    } else if (synced > 0) {
                        // Partial sync
                        showStatus(
                            `‚è≥ Syncing... ${synced}/${expectedCount} radiators updated`,
                            'success'
                        );
                    }

                } catch (error) {
                    console.error('Verification poll error:', error);
                }
            }

            // Timeout - show warning
            showStatus(
                `‚ö†Ô∏è Set to ${targetTemp}¬∞C but Netatmo sync slow. Check in a few moments.`,
                'error'
            );
            loadZoneStatus(); // Final refresh
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;

            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Load zone status immediately (non-blocking)
        setTimeout(() => loadZoneStatus(), 0);

        // Auto-refresh every 5 seconds (like BESS)
        refreshInterval = setInterval(loadZoneStatus, 5000);
    </script>
</body>
</html>
